<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IPFS 下载助手</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      padding: 0;
    }
    #progress {
      text-align: center;
      margin-top: 20px;
    }
    button {
      width: 250px;
      margin-top: 10px;
    }
    strong {
      font-size: larger;
    }
  </style>
  <link rel="stylesheet" href="/water.css">
  <link rel="shortcut icon" href="/favicon.ico">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7692266966719684"
    crossorigin="anonymous"></script>
</head>
<body>
  <h1>IPFS 下载工具</h1>
  <div id="default" style="display: none;">
    <h2>请输入文件信息</h2>
    <label for="filename">文件名&nbsp;</label>
    <input id="filename" type="text">
    <label for="filepath">文件路径（CID）</label>
    <input id="filepath" type="text">
    <a id="quick-download-link" target="_blank"><button><strong>快速下载</strong><br>速度更快，消耗更多流量</button> </a><br>
    <a id="inbrowser" target="_blank"><button><strong>inbrowser下载</strong><br>安全，需浏览器支持</button> </a><br>
    <a id="slow-download-link" target="_blank"><button><strong>备用下载</strong><br>但是较慢，较节约流量</button></a><br>
    <a id="old-version-download-link" target="_blank"><button><strong>高级下载</strong><br>手动选取下载点，进阶</button></a>
  </div>
  <p id="progress"></p>
  <div id="success" style="display: none; text-align: center;">
    <p><strong>下载已完成，如果浏览器没有弹出文件保存对话框，请点击下方按钮手动保存</strong></p>
    <a id="save"><button><strong>保存文件</strong></button></a>
  </div>
  <blockquote>本工具仅用于通过文件参数从现有 IPFS 网络中下载文件，并不存储任何数据。请检查所得到的文件和所需要的文件是否一致。</blockquote>
  <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/axios/0.26.0/axios.min.js"
    type="application/javascript"></script>
  <script>
    var urlParams = new URLSearchParams(window.location.search);
    var filename = decodeURIComponent(urlParams.get('filename'));
    var path = window.location.pathname.slice(1).replace(/^ipfs\//, '');
    var query = urlParams.toString();

    document.getElementById('filename').value = filename || '';
    document.getElementById('filepath').value = path || '';

    document.getElementById('filename').addEventListener('input', updateUrl);
    document.getElementById('filepath').addEventListener('input', updateUrl);

    function updateUrl() {
      filename = document.getElementById('filename').value;
      path = document.getElementById('filepath').value;
      if (filename && path) {
        updateButton();
        window.history.pushState({}, '', `/${path}?filename=${filename}`);
      }
    }

    function updateButton() {
      let quickDownloadLink = document.querySelector('#quick-download-link');
      let slowDownloadLink = document.querySelector('#slow-download-link');
      let oldVersionDownloadLink = document.querySelector('#old-version-download-link');
      let inbrowserlink = document.querySelector('#inbrowser');
      window.history.pushState({}, '', `/${path}?filename=${filename}`);
      quickDownloadLink.href = `/${path}?filename=${filename}#quick`;
      slowDownloadLink.href = `/${path}?filename=${filename}#slow`;
      oldVersionDownloadLink.href = `https://check.ipfs.1kbtool.com/${path}?filename=${filename}`;
      inbrowserlink.href = `https://${path}.ipfs.inbrowser.link/?download=true&filename=${filename}`;
    }

    function downloadWithProgress(url, controller = null) {
      return new Promise((resolve, reject) => {
        const config = {
          responseType: 'arraybuffer',
          onDownloadProgress: (progressEvent) => {
            let progress;
            if (!progressEvent.total) {
              progress = 0;
            } else {
              progress = (progressEvent.loaded / progressEvent.total) * 100;
            }
            maxProgress = Math.max(maxProgress, progress);
            updateProgress();
          }
        };
        if (controller) {
          config.signal = controller.signal;
        }
        axios.get(url, config)
          .then((response) => resolve(response.data))
          .catch((error) => reject(error));
      });
    }

    function saveLocally(data) {
      const blob = new Blob([data]);
      const link = document.getElementById('save');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    if (window.location.hash === '#slow' || window.location.hash === '#quick') {
      if (!filename || !path) {
        alert('文件名或路径为空，请返回上一页面查看使用说明');
        throw new Error('文件名或路径为空！');
      }

      const downloadUrls = [
        `https://gw.crustgw.work/ipfs/${path}`,
        `https://ipfs.io/ipfs/${path}`,
        `https://${path}.ipfs.dweb.link/`
      ];

      var maxProgress = 0;
      var progressCount = 0;

      function updateProgress() {
        const progressElement = document.getElementById('progress');
        const formattedProgress = maxProgress.toFixed(1);
        progressElement.innerHTML = `文件名 <strong>${filename}</strong> <br> 下载进度 <strong>${formattedProgress}%</strong>`;
      }

      function tryNextDownload(index) {
        if (index >= downloadUrls.length) {
          alert('所有下载地址都已尝试完毕，请考虑手动下载');
          return;
        }
        const url = downloadUrls[index];
        downloadWithProgress(url)
          .then((data) => {
            let myDiv = document.getElementById('success');
            myDiv.style.display = 'block';
            saveLocally(data);
          })
          .catch(() => tryNextDownload(index + 1));
      }

      updateProgress();
      tryNextDownload(progressCount);
    } else {
      let myDiv = document.getElementById('default');
      myDiv.style.display = 'block';
      updateButton();
    }
  </script>
</body>
</html>
